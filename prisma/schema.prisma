// Prisma schema for Vereen healthcare application
// Replaces in-memory stores with persistent database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Client entity - Healthcare client information
model Client {
  id           String   @id @default(cuid()) @map("client_id")
  name         String
  dob          String
  bsnEncrypted String?  @map("bsn_encrypted")
  wlzProfile   String   @map("wlz_profile")
  provider     String
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  notes           Note[]
  measures        Measure[]
  incidents       Incident[]
  evidenceLinks   EvidenceLink[]
  auditEvents     AuditEvent[]
  meerzorgApps    MeerzorgApplication[]
  normativeChecks NormativeCheck[]
  trendMonitoring TrendMonitoring[]
  riskFlags       RiskFlag[]
  mdReviews       MdReview[]

  @@map("clients")
}

// Note entity - Healthcare notes and observations
model Note {
  id       String @id @default(cuid())
  clientId String @map("client_id")
  date     String
  author   String
  section  String
  text     String

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@map("notes")
}

// Measure entity - Healthcare measurements and assessments
model Measure {
  id       String  @id @default(cuid())
  clientId String  @map("client_id")
  date     String
  type     String // e.g., 'Katz-ADL', 'GAF', 'NPI', 'MMSE'
  score    String
  comment  String?

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([type])
  @@map("measures")
}

// Incident entity - Healthcare incidents and events
model Incident {
  id          String @id @default(cuid())
  clientId    String @map("client_id")
  date        String
  type        String
  severity    String
  description String

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([severity])
  @@map("incidents")
}

// EvidenceLink entity - Links evidence to criteria evaluations
model EvidenceLink {
  id         String   @id @default(cuid())
  clientId   String   @map("client_id")
  targetPath String   @map("target_path") // e.g., 'uc2.criteria.ADL', 'uc1.meerzorg.form_field'
  sourceType String   @map("source_type") // 'note', 'measure', 'incident', 'document'
  sourceId   String   @map("source_id")
  snippet    String
  relevance  Float    @default(0.0) // 0.0 to 1.0
  confidence Float    @default(0.0) // 0.0 to 1.0
  createdBy  String   @map("created_by") // 'ai' or user identifier
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([targetPath])
  @@index([sourceType])
  @@map("evidence_links")
}

// AuditEvent entity - Audit trail for all actions
model AuditEvent {
  id       String   @id @default(cuid())
  ts       DateTime @default(now())
  actor    String // 'ai' | 'user@email.com'
  clientId String?  @map("client_id")
  action   String
  meta     String // JSON string

  // Relations
  client Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([actor])
  @@index([ts])
  @@map("audit_events")
}

// ============================================================================
// UC1 - Meerzorg Application Tables
// ============================================================================

// MeerzorgApplication entity - Meerzorg funding applications
model MeerzorgApplication {
  id          String    @id @default(cuid())
  clientId    String    @map("client_id")
  status      String    @default("draft") // draft, in_review, submitted, approved, rejected
  formData    String    @map("form_data") // JSON string with form fields
  version     String    @default("2026") // Framework version: 2025, 2026
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  submittedAt DateTime? @map("submitted_at")
  submittedBy String?   @map("submitted_by")

  // Relations
  client          Client             @relation(fields: [clientId], references: [id], onDelete: Cascade)
  formFields      MeerzorgFormData[]
  normativeChecks NormativeCheck[]
  reviewWorkflows ReviewWorkflow[]

  @@index([clientId])
  @@index([status])
  @@map("meerzorg_applications")
}

// MeerzorgFormData entity - Form field mappings from dossier
model MeerzorgFormData {
  id            String   @id @default(cuid())
  applicationId String   @map("application_id")
  fieldName     String   @map("field_name")
  fieldValue    String   @map("field_value")
  sourceType    String   @map("source_type") // note, measure, incident, document
  sourceId      String   @map("source_id")
  confidence    Float    @default(0.0) // 0.0 to 1.0
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  application MeerzorgApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([fieldName])
  @@map("meerzorg_form_data")
}

// NormativeCheck entity - Validation results against Toetsingskader
model NormativeCheck {
  id            String   @id @default(cuid())
  applicationId String?  @map("application_id") // nullable for general client checks
  clientId      String   @map("client_id")
  checkType     String   @map("check_type") // e.g., 'required_field', 'toetsingskader_rule', 'completeness'
  ruleId        String   @map("rule_id") // identifier for the specific rule
  status        String // pass, fail, warning
  message       String
  severity      String   @default("medium") // low, medium, high, critical
  checkedAt     DateTime @default(now()) @map("checked_at")

  // Relations
  application MeerzorgApplication? @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  client      Client               @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([clientId])
  @@index([status])
  @@map("normative_checks")
}

// ReviewWorkflow entity - Approval workflow states
model ReviewWorkflow {
  id            String   @id @default(cuid())
  applicationId String   @map("application_id")
  reviewerRole  String   @map("reviewer_role") // professional, backoffice, admin
  reviewerName  String   @map("reviewer_name")
  status        String // pending, approved, rejected, needs_revision
  comments      String?
  reviewedAt    DateTime @default(now()) @map("reviewed_at")

  // Relations
  application MeerzorgApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([status])
  @@map("review_workflow")
}

// ============================================================================
// UC2 - Herindicatie Enhancement Tables
// ============================================================================

// TrendMonitoring entity - Time-series data for trend detection
model TrendMonitoring {
  id          String   @id @default(cuid())
  clientId    String   @map("client_id")
  metricType  String   @map("metric_type") // care_hours, incident_count, bpsd_score, adl_score
  metricValue Float    @map("metric_value")
  periodStart String   @map("period_start") // Date string
  periodEnd   String   @map("period_end") // Date string
  recordedAt  DateTime @default(now()) @map("recorded_at")

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([metricType])
  @@index([recordedAt])
  @@map("trend_monitoring")
}

// RiskFlag entity - Automated risk flags for clients
model RiskFlag {
  id          String    @id @default(cuid())
  clientId    String    @map("client_id")
  flagType    String    @map("flag_type") // increased_care, high_incidents, deteriorating_adl
  severity    String // low, medium, high, critical
  description String
  flaggedAt   DateTime  @default(now()) @map("flagged_at")
  resolvedAt  DateTime? @map("resolved_at")
  resolvedBy  String?   @map("resolved_by")

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([severity])
  @@index([flaggedAt])
  @@map("risk_flags")
}

// MdReview entity - Multidisciplinary team review notes
model MdReview {
  id                    String   @id @default(cuid())
  clientId              String   @map("client_id")
  reviewerName          String   @map("reviewer_name")
  reviewerRole          String   @map("reviewer_role") // physician, psychologist, ergo, physio, nurse
  clinicalNotes         String   @map("clinical_notes")
  decision              String // approve, observe, reject
  observationPeriodDays Int?     @map("observation_period_days")
  reviewedAt            DateTime @default(now()) @map("reviewed_at")

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([decision])
  @@map("md_reviews")
}

// ============================================================================
// UC3 - AI Onboarding Assistant Tables
// ============================================================================

// AlgorithmeLibrary entity - Cache of algorithms from algoritmes.overheid.nl
model AlgorithmeLibrary {
  id              String   @id @default(cuid())
  externalId      String?  @unique @map("external_id") // ID from algoritmes.overheid.nl
  name            String
  organization    String   // Organization that developed/uses the algorithm
  description     String   // Full description
  shortDescription String? @map("short_description") // Brief summary
  domain          String   // zorg, onderwijs, veiligheid, etc.
  category        String?  // Sub-category within domain
  riskLevel       String   @map("risk_level") // hoog, beperkt, minimaal
  aiActCategory   String?  @map("ai_act_category") // EU AI Act classification
  status          String   @default("active") // active, deprecated, pilot
  sourceUrl       String?  @map("source_url")
  contactEmail    String?  @map("contact_email")
  tags            String?  // JSON array of tags for matching
  useCases        String?  @map("use_cases") // JSON array of use case descriptions
  requirements    String?  // JSON object with technical requirements
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  onboardingSolutions OnboardingSolution[]

  @@index([domain])
  @@index([riskLevel])
  @@index([organization])
  @@map("algorithme_library")
}

// OnboardingSession entity - Chat sessions with users
model OnboardingSession {
  id              String    @id @default(cuid())
  userId          String?   @map("user_id") // Optional user identifier
  sessionStatus   String    @default("active") @map("session_status") // active, completed, abandoned
  currentPhase    String    @default("problem_analysis") @map("current_phase") // problem_analysis, solutions, implementation
  organizationType String?  @map("organization_type") // gemeente, zorginstelling, etc.
  organizationName String?  @map("organization_name")
  problemSummary  String?   @map("problem_summary") // AI-generated summary of the problem
  selectedDomain  String?   @map("selected_domain")
  dataAvailability String?  @map("data_availability") // JSON with data types available
  priorities      String?   // JSON array of user priorities
  constraints     String?   // JSON array of constraints
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  completedAt     DateTime? @map("completed_at")

  // Relations
  messages          OnboardingMessage[]
  solutions         OnboardingSolution[]
  implementationPlan ImplementationPlan?

  @@index([sessionStatus])
  @@index([currentPhase])
  @@index([createdAt])
  @@map("onboarding_sessions")
}

// OnboardingMessage entity - Messages within a session
model OnboardingMessage {
  id        String   @id @default(cuid())
  sessionId String   @map("session_id")
  role      String   // user, assistant, system
  content   String   // Message content
  messageType String @default("text") @map("message_type") // text, solution_list, implementation_plan, question
  metadata  String?  // JSON with extra data (e.g., suggested options, extracted entities)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  session OnboardingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
  @@map("onboarding_messages")
}

// OnboardingSolution entity - Proposed solutions for a session
model OnboardingSolution {
  id           String   @id @default(cuid())
  sessionId    String   @map("session_id")
  algorithmId  String?  @map("algorithm_id") // Reference to AlgorithmeLibrary
  rank         Int      // Order in the list (1 = best match)
  matchScore   Float    @map("match_score") // 0.0 to 1.0
  matchReason  String   @map("match_reason") // AI explanation of why this matches
  isSelected   Boolean  @default(false) @map("is_selected")
  selectedAt   DateTime? @map("selected_at")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  session   OnboardingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  algorithm AlgorithmeLibrary? @relation(fields: [algorithmId], references: [id])

  @@index([sessionId])
  @@index([algorithmId])
  @@index([isSelected])
  @@map("onboarding_solutions")
}

// ImplementationPlan entity - Generated implementation plans
model ImplementationPlan {
  id                String   @id @default(cuid())
  sessionId         String   @unique @map("session_id")
  planVersion       Int      @default(1) @map("plan_version")
  executiveSummary  String   @map("executive_summary")
  stepsJson         String   @map("steps_json") // JSON array of implementation steps
  rolesRequired     String   @map("roles_required") // JSON array of required roles
  complianceChecklist String @map("compliance_checklist") // JSON array of compliance items
  riskAssessment    String?  @map("risk_assessment") // JSON with risks and mitigations
  estimatedDuration String?  @map("estimated_duration") // e.g., "3-6 months"
  budgetIndication  String?  @map("budget_indication") // e.g., "€10k-€50k"
  governanceModel   String?  @map("governance_model") // VNG governance alignment
  nextSteps         String?  @map("next_steps") // JSON array of immediate actions
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  session OnboardingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("implementation_plans")
}

// ============================================================================
// Shared Infrastructure Tables
// ============================================================================

// FrameworkVersion entity - Track regulatory framework versions
model FrameworkVersion {
  id            String   @id @default(cuid())
  frameworkType String   @map("framework_type") // toetsingskader, vv8, meerzorg
  version       String // 2025, 2026
  effectiveFrom String   @map("effective_from") // Date string
  effectiveTo   String?  @map("effective_to") // Date string, null if current
  rulesJson     String   @map("rules_json") // JSON string with rules
  templatePath  String?  @map("template_path") // Path to template file
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([frameworkType, version])
  @@index([frameworkType])
  @@map("framework_versions")
}
